# -*- coding: utf-8 -*-
#:kivy 1.9.0
#:import win kivy.core.window
#:import expanduser os.path.expanduser

<EditorScreen@Screen>:
    slides_view: _slides_view
    action_bar: _action_bar
    BoxLayout:
        orientation: 'vertical'
        id: build_view
        ActionBar:
            id: _action_bar
            EditorBar:
        SlidesView:
            id: _slides_view

<EditorBar@ContextualActionView>:
    use_separator: True
    ActionPrevious:
        app_icon: app.icon
        title:'Hadaly'
        with_previous: False
    ActionButton:
        text: app.presentation['title']
        horizontal: root.center_y
        on_press: app.set_presentation_title()
    ActionButton:
        on_press: app.show_file_explorer()
        font_name: 'data/fonts/fontawesome-webfont.ttf'
        font_size: '20sp'
        text: u'\uf0fe'
    ActionButton:
        on_press: app.root.current = 'search'
        font_name: 'data/fonts/fontawesome-webfont.ttf'
        font_size: '20sp'
        text: u'\uf002'
    ActionButton:
        on_press: app.switch_to_viewer()
        font_name: 'data/fonts/fontawesome-webfont.ttf'
        font_size: '20sp'
        text: u'\uf06e'
    ActionGroup:
        mode: 'spinner'
        font_name: 'data/fonts/fontawesome-webfont.ttf'
        font_size: '20sp'
        text:u'\uf0c9'
        id: action_group
        size: (_save_as.texture_size[0] + 10, self.size[1])
        ActionButton:
            text: _('New')
            on_press: app.create_presentation()
        ActionButton:
            text: _('Open')
            on_press: app.show_open()
        ActionButton:
            text: _('Save')
            on_press: app.show_save('save')
        ActionButton:
            text: _('Save as...')
            id: _save_as
            on_press: app.show_save('save_as')
        ActionButton:
            text: _('Quit')
            on_press: app.stop()

<SlidesView@FloatLayout>:
    app: app
    grid_layout: _grid_layout
    modified: None
    BoxLayout:
        padding: [dp(20), dp(20), dp(20), dp(20)]
        ScrollView:
            do_scroll_x: False
            GridLayout:
                app: app
                spacing: dp(20)
                cols: app.config.getint('editor', 'cols')
                height: self.minimum_height
                id: _grid_layout
                size_hint_y: None

<DraggableSlide>:
    ncols: app.config.getint('editor', 'cols')
    size_hint: None, None
    size: [dp(int(win.Window.width / self.ncols) - 20 - int(20/self.ncols))] * 2

<Slide>:
    app: app
    orientation:'vertical'
    size_hint: None, None
    padding: [dp(10), dp(10), dp(10), 0]
    spacing: dp(3)
    image: _image
    canvas.before:
        Color:
            rgba: (128, 128, 128, 0.3)
        Rectangle:
            pos: self.pos
            size: self.size
    Image:
        id: _image
        source: root.thumb_src
        keep_ratio: True
        mipmap: True
    Button:
        size_hint: 0.15, 0.25
        text: u'\uf05a'
        text_size: self.size
        font_name: 'data/fonts/fontawesome-webfont.ttf'
        font_size: ''.join((str(int(root.width / 8)), 'sp'))
        halign: 'center'
        valign: 'middle'
        background_color: [1, 1, 1, 0]
        border_color: [1,1,1,1]
        on_press: root.show_info_panel(self.pos)


<SlideInfo@Bubble>:
    artist: _artist
    title: _title
    year: _year
    font: '10sp'
    arrow_pos:'left_mid'
    orientation:'vertical'
    size_hint: (None, None)
    size: (dp(150), dp(60))
    SlideLabel:
        id: _artist
        font_size: root.font
    SlideLabel:
        id: _title
        italic: True
        font_size: root.font
    SlideLabel:
        id: _year
        font_size: root.font


<SlideLabel@Label>:
    text_size: self.width, None
    size_hint_y: None
    height: self.texture_size[1]
    shorten: True
    shorten_from: 'right'
    halign: 'left'
    valign: 'middle'


<SlideInfoDialog>:
    title: _('Informations')
    app: app
    size: [dp(size / 1.5) for size in app.root.size]
    size_hint: None, None
    content: _popup_content
    title_field: _title_field
    artist_field: _artist_field
    year_field: _year_field
    BoxLayout:
        id: _popup_content
        orientation: 'vertical'
        padding: [dp(10),dp(10),dp(10),dp(10)]
        spacing: dp(20)
        AsyncImage:
            id: _image
            source: root.slide.thumb_src
            keep_ratio: True
        BoxLayout:
            size_hint: (1, None)
            orientation: 'vertical'
            BoxLayout:
                orientation: 'horizontal'
                Label:
                    text: _('Artist')
                    size_hint_x: 0.3
                TextInput:
                    focus: True
                    focus_next: _title_field
                    write_tab: False
                    multiline: False
                    text: root.slide.artist
                    on_text: root.slide.artist = self.text
                    id: _artist_field
            BoxLayout:
                orientation: 'horizontal'
                Label:
                    text: _('Title')
                    size_hint_x: 0.3
                TextInput:
                    focus_next: _year_field
                    focus_previous: _artist_field
                    write_tab: False
                    multiline: False
                    text: root.slide.title
                    on_text: root.slide.title = self.text
                    id: _title_field
                    on_text_validate: root.on_validate()
            BoxLayout:
                orientation: 'horizontal'
                Label:
                    text: _('Year')
                    size_hint_x: 0.3
                TextInput:
                    focus_next: _artist_field
                    focus_previous: _title_field
                    write_tab: False
                    multiline: False
                    text: root.slide.year
                    on_text: root.slide.year = self.text
                    id: _year_field
                    on_text_validate: root.on_validate()

<TitleDialog@Popup>:
    title: _('Set title')
    size: 200, 100
    size_hint: None, None
    pres_title: _pres_title
    app: app
    BoxLayout:
        orientation: 'vertical'
        TextInput:
            text: app.presentation['title']
            multiline: False
            id: _pres_title
            on_text: app.presentation['title'] = self.text
            on_text_validate: root.dismiss()


<SaveDialog@Popup>:
    title: _('Save file')
    size_hint: 0.8, 0.8
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            on_selection: text_input.text = self.selection and self.selection[0] or ''
            filters: ['*.opah']
        TextInput:
            id: text_input
            text: '*.opah'
            size_hint_y: None
            height: 30
            multiline: False
        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: _('Cancel')
                on_release: root.dismiss()
            Button:
                text: _('Save')
                on_press: app.save(filechooser.path, text_input.text)
                on_release: root.dismiss()

<OpenDialog@Popup>:
    title: _('Open file')
    size_hint: 0.8, 0.8
    BoxLayout:
        size: root.size
        pos: root.pos
        orientation: "vertical"
        FileChooserListView:
            id: filechooser
            on_selection: text_input.text = self.selection and self.selection[0] or ''
            filters: ['*.opah']
            path: expanduser('~')
        TextInput:
            id: text_input
            text: '*.opah'
            size_hint_y: None
            height: 30
            multiline: False
        BoxLayout:
            size_hint_y: None
            height: 30
            Button:
                text: _('Cancel')
                on_release: root.dismiss()
            Button:
                text: _('Open')
                on_press: app.load_slides(filechooser.path, filechooser.selection)
                on_release: root.dismiss()